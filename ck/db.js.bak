//mysql 모듈 로딩

//mysql password : bonobono
var mysql = require('mysql');
var async = require('async');

var connection;

module.exports = function() {

	connection = mysql.createConnection({
		host : 'localhost',	//**********이부분 체크
		port : 3306,		//mysql 통신포트
		user : 'root',
		password : 'bonobono',
		database : 'mainbono'
	});

	connection.connect(function(err) {
		if (err) {
			console.error('mysql connection error');
			console.error(err);
			throw err;
		} else {
			console.log("연결성공!");
		}
	});

	return {
		user: { 
			create: create_,
			login: login_,
			view: view_,
			create_project: create_project_,
			invite: invite_,
			join: join_  
		}
	};
}

/*************************
 LOGIN
 : 사용자 login 기능 
**************************/
function login_ (_id, _pw, login_handler, socket) {
	var query = connection.query("SELECT user_id FROM userinfo WHERE user_id = ? AND pw = ?"
				, [_id,_pw], function(err,rows) {
		if(err) {
			console.log("[login] : DB ERROR");
			console.error(err);
			//throw err;
			return;
		} else {
			console.log("[login] : ", query.sql);

			if(rows.length == 0) {
				console.log("[login] : login failed.")
				login_handler(false, socket);
			} else {
				console.log("[login] : login successful.")
				login_handler(true, socket);
			}
		}
	});
}

/*************************
 CREATE
 : 회원가입 기능 
**************************/
function create_ (_id, _pw, _email, join_handler, socket) {

	// 1. check if id is duplicate.

	var query = connection.query("SELECT user_id FROM userinfo WHERE user_id = ?"
				, [_id], function(err,rows) {

					if (err) {
						console.log("[join, " + _id + "] : error");
						console.error(err);
						return;

					} else {
//						console.log("[login] : ", query.sql);

						if (rows.length != 0) {
							console.log("[join, " + _id + "] : error");
							join_handler(false, socket);

						} else {

							var query = connection.query("INSERT INTO userinfo(user_id, pw, email) VALUES(?, ?, ?)"
								, [_id, _pw, _email], function(err, result) {
									if (err) {
										console.error(err);
										throw err;

									} else {
										console.log(query.sql);
										console.log("[join, " + _id + "] : successful");
										join_handler(true, socket);
									}
								});
						}
					}

				});
			}

/*************************
 VIEW
 : 사용자 project 조회 기능 
**************************/
function view_ (_id, pview_handler, socket) {

	var projectList = [];
	var query = connection.query("SELECT * FROM userproject WHERE user_id = ?", _id, function(err,rows) {
		
		if (err) {
    		console.log("[project view] : project list error");
			console.error(err);
			pview_handler(false, socket, null);

			return;
		} else {
			var projectList = [];

			for(idx in rows) {
				projectList.push(rows[idx]['project']);
			}
			
			console.log("[project view] : project list", projectList);
			pview_handler(true, socket, JSON.stringify(projectList));
		}
	});

	return projectList;
}

/*************************
 INVITE
 : 타 사용자 초대 기능 
**************************/
function invite_ (_inviting_id, _invited_id, _inv_project, _inv_msg) {
	var query = connection.query("INSERT INTO invitation(inviting_user, invited_user, inv_project, inv_msg) VALUES (?, ?, ?, ?)"
		, [_inviting_id, _invited_id, _inv_project, _inv_msg], function(err, rows) {
		if(err) {
			console.log("invite query error");
			console.error(err);
			throw err;
		} else {
			console.log( _inviting_id + " invited " + _invited_id + " in " + _inv_project + " says " + _inv_msg);
			//사용자가 초대를 수락하면,
			//JOIN <== userproject 테이블에 record 추가
		}
	});
}

/***********************************
 JOIN
 : 초대 수락 => 프로젝트에 참여 기능 
************************************/
function join_ (_id, _projname) {
	var query = connection.query("INSERT INTO userproject (user_id, project) VALUES (?, ?)", [_id, _projname], 
		function(err,result) {
		if(err) {
			console.log("join query error");
			console.error(err);
			throw err;
		} else {
			console.log("join ok");
			//notification table 수정 필요
		}
	});
}


/*************************
 CREATE_PROJECT
 : project 추가 기능 
**************************/
function create_project__ (_projname, _desc) {
	var query = connection.query("INSERT INTO projectinfo(project_name, description) VALUES(?, ?)"
						, [_projname, _desc], function(err, result) {
		if (err) {
			console.log("create_project query error");
			console.error(err);
			throw err;
		} else {
			console.log("project insert ok");
		}
	});
}

// obj.user_name, obj.project_name, obj.project_desc
function create_project_ (obj, pcreate_handler, socket) {

	var task0 = function(callback)
	{

	};

	var task1 = connection.query;

	var task2 = connection.query;



	var query = connection.query("INSERT INTO projectinfo(project_name, description) VALUES(?, ?)"
		, [_projname, _desc], function(err, result) {

			// 0. db : check project name duplicate
			// 1. db : get user email
			// 2. git : new project (create origin folder and git init)
			// 3. db : add new project
			// 4. git : join project (create folder and git clone)
			// 5. db : add userproject



		if (err) {
			console.log("create_project query error");
			console.error(err);
			throw err;
		} else {
			console.log("project insert ok");
		}
	});
}

